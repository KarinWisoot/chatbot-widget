((t,o)=>{t.ChatBotWidget={defaultConfig:{ip:"127.0.0.1",apiBase:"/api/v1",cookieChatKey:"chat_id",cookieTokenKey:"token",cookieExpireHours:8,model:"itmfec",prompt:"ตอนนี้ฉันอยู่หน้า {path} ช่วยฉันหน่อยได้ไหม",iconOpen:"chat-open.png",iconNew:"chat-new.png"},init(t={}){this.config={...this.defaultConfig,...t},this.createStyles(),this.createHTML(),this.bindEvents(),this.start()},setCookie(t,i,e){e=new Date(Date.now()+60*e*60*1e3).toUTCString();o.cookie=t+`=${i}; expires=${e}; path=/`},getCookie(t){return o.cookie.split(";").reduce((t,i)=>{var[i,e]=i.split("=").map(t=>t.trim());return t[i]=e,t},{})[t]},getFullUrl(t){return"http://"+this.config.ip+(t.startsWith("/")?t:"/"+t)},getUrlPath(){return t.location.pathname.replace(/^\/+|\/+$/g,"")},buildPrompt(){return encodeURIComponent(this.config.prompt.replace("{path}",this.getUrlPath()||"msync"))},createStyles(){var t=o.createElement("style");t.innerHTML=`
        html,body{margin:0;padding:0;}
        #chatbot-btn{position:fixed;bottom:24px;right:32px;z-index:1000;background:none;
          border:none;cursor:pointer;display:none;}
        #chatbot-btn img{width:72px;height:72px;}
        #chatbot-container{position:fixed;bottom:96px;right:32px;width:460px;height:690px;z-index:1001;
          border-radius:25px;overflow:hidden;background:#fff;opacity:0;visibility:hidden;
          transform:translateY(30px);
          transition:opacity .35s ease,visibility .35s ease,transform .35s ease;}
        #chatbot-container.active{opacity:1;visibility:visible;transform:translateY(0);}
        #chatbot-header{position:absolute;top:0;left:0;width:100%;height:52px;background:#171717;color:#fff;
          font-size:18px;font-weight:600;display:flex;align-items:center;justify-content:center;z-index:10;
          border-radius:20px 20px 5px 5px;}
        #chatbot-header button{background:none;border:none;color:#fff;cursor:pointer;width:44px;height:44px;
          display:flex;align-items:center;justify-content:center;position:absolute;top:6px;}
        #chatbot-new-btn{left:12px;}
        #chatbot-close-btn{right:12px;font-size:28px;line-height:28px;}
        #chat-frame{width:100%;height:100%;border:none;position:relative;z-index:1;}
        #chatbot-loading{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(18,18,18,0.85);
          z-index:20;display:flex;align-items:center;justify-content:center;color:white;font-size:18px;
          font-weight:500;letter-spacing:1px;visibility:hidden;opacity:0;transition:opacity .3s ease,visibility .3s ease;}
        #chatbot-loading.active{visibility:visible;opacity:1;}
      `,o.head.appendChild(t)},createHTML(){o.body.insertAdjacentHTML("beforeend",`
        <button id="chatbot-btn">
          <img src="${this.config.iconOpen}" />
        </button>
        <div id="chatbot-container">
          <header id="chatbot-header">
            <button id="chatbot-new-btn">
              <img src="${this.config.iconNew}" style="width: 36px; height: 36px" />
            </button>
            <button id="chatbot-close-btn">X</button>
          </header>
          <iframe id="chat-frame"></iframe>
          <div id="chatbot-loading" class="active">Loading...</div>
        </div>
      `),this.chatBtn=o.getElementById("chatbot-btn"),this.container=o.getElementById("chatbot-container"),this.closeBtn=o.getElementById("chatbot-close-btn"),this.newBtn=o.getElementById("chatbot-new-btn"),this.loading=o.getElementById("chatbot-loading"),this.chatFrame=o.getElementById("chat-frame")},bindEvents(){this.chatFrame.onload=()=>{this.loading.classList.remove("active"),this.chatBtn.style.display="block"},this.chatBtn.onclick=()=>this.container.classList.toggle("active"),this.closeBtn.onclick=()=>this.container.classList.remove("active"),this.newBtn.onclick=()=>this.startNewChat()},async signIn(){try{var t=await fetch(this.getFullUrl(this.config.apiBase+"/auths/signin"),{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Sign-in failed");var i=await t.json();this.setCookie(this.config.cookieTokenKey,i.token,this.config.cookieExpireHours)}catch(t){console.error("Sign-in error:",t),this.loading.innerText="Auth Failed"}},async fetchChats(){try{var t=this.getCookie(this.config.cookieTokenKey);if(!t)throw new Error("No token in cookies");var i=await fetch(this.getFullUrl(this.config.apiBase+"/chats/?page=1"),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+t}});if(!i.ok)throw new Error("Failed to fetch chats");var e=await i.json();0<e.length&&e[0].id&&this.setCookie(this.config.cookieChatKey,e[0].id,this.config.cookieExpireHours)}catch(t){console.error("FetchChats error:",t),this.loading.innerText="Failed to load chats"}},initChatFrameSrc(){var t=this.getCookie(this.config.cookieChatKey);this.chatFrame.src=t?this.getFullUrl("/c/"+t):this.getFullUrl(`/?model=${this.config.model}&q=`+this.buildPrompt())},startNewChat(){this.chatFrame.src=this.getFullUrl(`/?model=${this.config.model}&q=`+this.buildPrompt()),this.loading.classList.add("active")},async start(){this.loading.classList.add("active"),await this.signIn(),await this.fetchChats(),this.initChatFrameSrc()}}})(window,document);